<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>pH manager</title>
    <!-- import plugin script -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@1.0.1/dist/chartjs-plugin-dragData.min.js"></script>
    <script src="https://requirejs.org/docs/release/2.3.6/minified/require.js"></script>

    <script type="text/javascript" src="{{ url_for('static', filename = 'json2.js') }}"></script>

    <style>
        .parent-table {
            width: 100%;
            overflow-x: auto;
        }

        table {
            border: 1px solid black;

        }

        th, td {
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        input.time-input {
            width: 50px;
        }
    </style>
</head>
<body onload="onStart()">
<h1>pH #1</h1>
<!-- bar chart canvas element -->
<div id="channelRadios">
</div>
<div id="divchart" class="chart-container" style="position: relative; height:40vh; width:90vw">
    <canvas id="myChart" width="1800" height="400"></canvas>

    <p id="pointSelected">Point selected:</p>
    <div class="parent-table">
        <table id="tblData" style="width:100%">
            <tr id="firstRow">
                <td>Index</td>


            </tr>
            <tr id="secondRow">
                <td>Expected pH</td>


            </tr>
            <tr id="thirdRow">
                <td>Time</td>


            </tr>
        </table>
    </div>
    <div>
        <input id="add" type="submit" name="add_button" value="Add step">
        <progress id="animationProgress" max="1" value="0" style="width: 100%"></progress>
        <input id="start" type="submit" name="start_button" value="Start">
        <input id="stop" type="submit" name="stop_button" value="Stop">
        <input id="saveTemplate" type="submit" name="save_button" value="Save Template">
    </div>
    <div>
        <div>
            <label>Templates</label>
        </div>
        <div>
            <select name="templates" id="templatesList" size=4>
            </select>
        </div>
        <div>
            <input id="loadTemp" type="submit" name="load_button" value="Load Template">
            <input id="deleteTemp" type="submit" name="del_button" value="Delete Template">
        </div>
    </div>
</div>


<script>
    // Global parameters:
    // do not resize the chart canvas when its container does (keep at 600x400px)
    Chart.defaults.global.responsive = true;
    var tbl = document.getElementById("tblData");
    var timeFormat = 'HH:mm';
    var colCount = tbl.rows[0].cells.length;
    var rowCount = tbl.rows.length;

    function timeFromMinutes(minutes) {
        return newDateString(Math.floor(minutes / 60), minutes % 60);
    }

    function newDateString(hours, minutes) {
        return hours.toString().padStart(2, "0") + ":" + minutes.toString().padStart(2, "0");
    }

    function parseTimeToMinutes(value) {
        let split = value.split(":");
        return (parseInt(split[0]) * 60) + parseInt(split[1]);
    }

    function updateIndex() {
        for (var i = 1; i < tbl.rows[rowCount - 3].cells.length; i++) {
            tbl.rows[rowCount - 3].cells[i].innerHTML = i;
        }
    }

    function insertPointBefore(index) {
        var data = myChart.data.datasets[0].data;
        var oldPoint = data[index];
        var beforePoint = data.length > 0 ? data[index - 1] : null;
        var newPoint = {
            x: oldPoint.x - 10,
            y: oldPoint.y
        };
        if (beforePoint !== null && beforePoint.x > newPoint.x) {
            newPoint.x = beforePoint.x;
        }
        if (oldPoint.x < 0)
        {
            oldPoint.x = 0;
        }

        insertBefore(rowCount - 3, index, $("<td>" + index + "</td>")[0]);
        insertBefore(rowCount - 2, index, $("<td>").append($(generateInput(newPoint.y)))[0]);
        insertBefore(rowCount - 1, index, $("<td>").append($(generateInput(timeFromMinutes(newPoint.x))))[0]);

        data.splice(index, 0, newPoint);

        updateIndex();
    }

    function insertBefore(row, index, element)
    {
        let currentElement = tbl.rows[row].cells[index];
        currentElement.parentNode.insertBefore(element, currentElement);
    }

    function removePoint(index) {
        tbl.rows[rowCount - 1].cells[index].remove();
        tbl.rows[rowCount - 2].cells[index].remove();
        tbl.rows[rowCount - 3].cells[index].remove();

        myChart.data.datasets[0].data.splice(index, 1);
        updateIndex();
    }

    function setPoint(index, point) {
        colCount = tbl.rows[0].cells.length;
        rowCount = tbl.rows.length;

        tbl.rows[rowCount - 1].cells[index].children[0].value = timeFromMinutes(Math.floor(point.x));
        tbl.rows[rowCount - 2].cells[index].children[0].value = point.y;
    }

    // define the chart data
    var chartData = {
        {#labels: [],#}
        datasets: [{
            label: '{{ legend }}',
            fill: true,
            lineTension: 0.1,
            backgroundColor: "rgba(75,192,192,0.4)",
            borderColor: "rgba(75,192,192,1)",
            borderCapStyle: 'butt',
            borderDash: [],
            borderDashOffset: 0.0,
            borderJoinStyle: 'miter',
            pointBorderColor: "rgba(75,192,192,1)",
            pointBackgroundColor: "#fff",
            pointBorderWidth: 1,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "rgba(75,192,192,1)",
            pointHoverBorderColor: "rgba(220,220,220,1)",
            pointHoverBorderWidth: 2,
            pointRadius: 5,
            pointHitRadius: 10,
            data: 0,
            spanGaps: false,
            steppedLine: 'after',
            responsive: true
        }]
    };

    // get chart canvas
    var holder = document.getElementById("myChart");
    var ctx = document.getElementById("myChart").getContext("2d");
    var progress = document.getElementById('animationProgress');
    var processStop = false;
    document.getElementById("start").addEventListener("click", function () {
        anim(progress, 0, 17000, 10);

        $.ajax({
            url: "/start_button",
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({schedule: parseData()})
        });
    });

    document.getElementById("stop").addEventListener("click", function () {
        stopAnimation();
        $.ajax({
            url: "/stop_button",
            type: "POST"
        });
    });
    document.getElementById("add").addEventListener("click", function () {
        addValue();
        reloadChart()
    });

    document.getElementById("loadTemp").addEventListener("click", function () {

        loadTemplateFromFile();
    });

    document.getElementById("deleteTemp").addEventListener("click", function () {

        deleteTemplate();
    });

    document.getElementById("saveTemplate").addEventListener("click", function () {

        saveTemplate();
    });


    // create the chart using the chart canvas
    var myChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            dragData: true,
            dragX: true,
            dragDataRound: 2,
            onDrag: function (event, datasetIndex, index, value) {
                if (index <= 0) {
                    return;
                }
                var data = myChart.data.datasets[0].data;
				if(value.y>0){
					if (index > 0 && data[index - 1].x > value.x) {
						value.x = data[index - 1].x;
						return;
					} else if (index < data.length - 1 && data[index + 1].x < value.x) {
						value.x = data[index + 1].x;
						return;
					}
					if (value.y <= 0) {
						value.y = 0.01;
					}
				
					setPoint(index, value);
				}
            },
            onDragEnd: function (e, datasetIndex, index, value) {

                reloadChart();

            },
            scales: {
                yAxes: [{
                    ticks: {
                        max: 14,
                        min: 0,
                        stepSize: 1.0
                    }
                }],
                xAxes: [{
                    type: "linear",
                    ticks: {

                        precision: 0,
                        beginAtZero: true,
                        userCallback: function (label, index, labels) {
                            if (Math.floor(label) === label) {
                                return timeFromMinutes(label);
                            }
                        }
                    }
                }]
            },
            tooltips: {
                enabled: true,
                mode: 'single',
                callbacks: {
                    title: function (tooltipItems, data) {
                        return timeFromMinutes(tooltipItems[0].xLabel);
                    },
                    label: function (tooltipItems, data) {
                        firstPointCtx = "First Point Selected: ";
                        return tooltipItems.yLabel + ' pH';
                    }
                }
            }
        }
    });
    // get the text element below the chart
    var pointSelected = document.getElementById("pointSelected");

    // create a callback function that detects right-click event
    // then remove clicked point
    window.oncontextmenu = function(evt) {
        console.log(evt);
        var canvas = evt.target || evt.srcElement;
        console.log(canvas);
        console.log(canvas.getBoundingClientRect());
        console.log(myChart.getElementAtEvent(evt));
        var activePoint = myChart.getElementAtEvent(evt);
        if (activePoint.length <= 0) {
            return;
        }
        removePoint(activePoint[0]._index);
        reloadChart();
        e.preventDefault();
        return false;
    };

    // create a callback function for updating the selected index on the chart
    holder.onclick = function (evt) {
        console.log(evt);
        var activePoint = myChart.getElementAtEvent(evt);
        if (activePoint.length > 0 && evt.ctrlKey) {
            insertPointBefore(activePoint[0]._index);
            reloadChart();
        }
        else if (activePoint.length > 0 && evt.shiftKey) {
            removePoint(activePoint[0]._index);
            reloadChart();
        }
        else if (activePoint.length > 0) {
            console.log(activePoint);
            console.log('x:' + activePoint[0]._view.x);
            console.log('maxWidth: ' + activePoint[0]._xScale.maxWidth);
            console.log('y: ' + activePoint[0]._view.y);
            console.log('index: ' + activePoint[0]._index);
            pointSelected.innerHTML = 'Point selected... index: ' + (activePoint[0]._index + 1);
        }
    };

    function anim(element, time, maxTime, offset) {
        if (processStop === false) {
            element.value = time / maxTime;
            if (element.value >= 1) {
                return;
            }

            window.setTimeout(function () {
                anim(element, time + offset, maxTime, offset);
            }, Math.min(maxTime - time, offset));
        } else processStop = false;
    }

    function stopAnimation() {
        processStop = true;
    }

    function generateInput(value) {
        let input = document.createElement("input");
        input.className = "time-input";
        input.size = "1";
        input.type = "text";
        input.value = value;
        input.onchange = function () {
            reloadChart();
        };
        return input;
    }

    var iter = 1;

    function addValue() {

        $("#tblData").find('tr').each(function () {
            var trow = $(this);
            if (trow.index() === 0) {
                trow.append("<td>" + iter + "</td>");
            } else {

                var input;
                if (colCount > 2) {
                    input = generateInput(trow.index() === 1 ? "7.00" : timeFromMinutes(parseTimeToMinutes(tbl.rows[rowCount - 1].cells[colCount - 1].children[0].value) + 10));

                } else {
                    input = generateInput(trow.index() === 1 ? "0" : "00:00");
                }
                console.log(input);
                trow.append($("<td>").append($(input)));
            }
        });
        iter += 1;
    }

    function reloadChart() {
        myChart.data.datasets[0].data = parseData();
        myChart.update();
    }

    function createChannels() {
        var div = document.getElementById('channelRadios');
        for (var i = 0; i < {{numberOfChannels}}; i++) {

            console.log({{numberOfChannels}});

            var node = document.createElement('div');
            node.innerHTML = '<input type="radio" id="check' + i + '" name="check"><label for="check' + i + '">' + 'channel' + i + '</label>';
            div.appendChild(node);
        }

    }

    function loadListOfTemplates() {
        $.get("/schedules", function (data) {
            var files = data.split(" ");
            console.log(files);

            var list = document.getElementById("templatesList");

            for (let file in files) {
                var option = document.createElement("option");
                option.innerHTML = files[file];

                console.log(files[file]);
                list.add(option);
            }
        });
    }

    function loadTemplateFromFile() {
        var selectedTemplate = $("#templatesList").children("option:selected").val();
        if (!selectedTemplate) {
            alert("You have to choose file");
        } else {
            $.get("/getTemplateSchedule", {templateName: selectedTemplate}).done(function (data) {
                var schedule = data.schedule.map(x => {
                    return {x: x.interval, y: x.pH};
                });


                colCount = tbl.rows[0].cells.length;

                for (i = 1; i < colCount; i++) {
                    var row1 = document.getElementById("firstRow");
                    var row2 = document.getElementById("secondRow");
                    var row3 = document.getElementById("thirdRow");
                    row1.deleteCell(-1);
                    row2.deleteCell(-1);
                    row3.deleteCell(-1);

                }
                colCount = tbl.rows[0].cells.length;
                rowCount = tbl.rows.length;
                iter = 1;
                var actualTime = 0;


                for (var i = 0; i < schedule.length; i++) {
                    addValue();
                    actualTime += schedule[i].x;
                    setPoint(i + 1, {
                        x: actualTime,
                        y: schedule[i].y
                    });
                }
                reloadChart();
            });
        }

    }

    function deleteTemplate() {
        var selectedTemplate = $("#templatesList").children("option:selected").val();
        if (!selectedTemplate) {
            alert("You have to choose file");
        } else {
            $.get("/deleteTemplate", {templateName: selectedTemplate});
            $('#templatesList').children('option').remove();
            loadListOfTemplates();
        }
    }


    function saveTemplate() {

        $.ajax({
            url: "/saveTemplate",
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({schedule: parseData()})
        });

        $('#templatesList').children('option').remove();
        loadListOfTemplates();
    }


    function loadChartFromFile() {
        $.get("/schedule", function (data) {
            var schedule = data.schedule.map(x => {
                return {x: x.interval, y: x.pH};
            });

            var actualTime = 0;


            for (var i = 0; i < schedule.length; i++) {
                addValue();
                colCount = tbl.rows[0].cells.length;
                rowCount = tbl.rows.length;
                actualTime += schedule[i].x;
                setPoint(i + 1, {
                    x: actualTime,
                    y: schedule[i].y
                });
            }
            reloadChart();
        });
    }

    function onStart() {
        createChannels();
        loadChartFromFile();
        loadListOfTemplates();
    }

    function parseData() {
        var schedule = [];

        colCount = tbl.rows[0].cells.length;
        rowCount = tbl.rows.length;

        var i = 1;

        schedule.push({
            x: parseTimeToMinutes("00:00"),
            y: tbl.rows[rowCount - 2].cells[i].children[0].value
        });
        for (i = 1; i < colCount; i++) {
            schedule.push({
                x: parseTimeToMinutes(tbl.rows[rowCount - 1].cells[i].children[0].value),
                y: tbl.rows[rowCount - 2].cells[i].children[0].value
            });
        }

        return schedule;
    }

</script>

</body>
</html>

